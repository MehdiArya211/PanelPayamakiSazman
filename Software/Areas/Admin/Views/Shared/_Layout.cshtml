@using DTO.Menu
@using Services.SessionServices
@using Domain.Resources

@{
    var User = Context.Session.GetUser();
    var Menus = User?.Menus ?? new List<MenuSessionDTO>();

    string currentArea = ViewContext.RouteData.Values["Area"]?.ToString()?.ToLower() ?? "";
    string currentController = ViewContext.RouteData.Values["Controller"]?.ToString()?.ToLower() ?? "";
    string currentAction = ViewContext.RouteData.Values["Action"]?.ToString()?.ToLower() ?? "";

    Layout = null;
}

<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>پنل مدیریت – @Config.SiteNameFa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- DataTables Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

    <!-- TomSelect -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    <link href="~/admin.css" rel="stylesheet" />


    <!-- GLOBAL THEME + SIDEBAR + RESPONSIVE + DATATABLE PAGING -->
    <style>
        /* ============================================================
                   ZBM ADMIN PANEL – MAIN STYLESHEET
                   Clean + Organized + Responsive + Dark Mode Supported
                   ============================================================ */


        /* ===========================
                   GLOBAL VARIABLES
                   =========================== */
        :root {
            --primary: #0d6efd;
            --primary-soft: rgba(13,110,253,.08);
            --bg-sidebar: #ffffff;
            --bg-navbar: #ffffff;
            --bg-body: #f3f4f6;
            --text-main: #111827;
            --text-muted: #6b7280;
        }

        body.dark {
            --bg-sidebar: #1e1e1e;
            --bg-navbar: #1f1f1f;
            --bg-body: #181818;
            --text-main: #e5e5e5;
            --text-muted: #9ca3af;
            --primary-soft: rgba(13,110,253,.30);
        }

        body {
            background: var(--bg-body);
            font-family: "IRANSans", "Segoe UI", sans-serif;
            overflow-x: hidden;
        }

    </style>


    @RenderSection("Styles", required: false)
</head>



<body>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebarMenu">

        <div class="p-3 fw-bold border-bottom text-center">
            📩 @Config.SiteNameFa
        </div>

        <!-- PROFILE -->
        <div class="border-bottom p-3 text-center">
            <img src="~/assets/img/user-icon.svg" width="65" class="rounded-circle mb-2"
                 data-bs-toggle="collapse" data-bs-target="#profileMenu" />

            <div class="fw-bold mt-2" data-bs-toggle="collapse" data-bs-target="#profileMenu">
                @User.FullName
            </div>

            <div class="collapse mt-3" id="profileMenu">

                <a class="sidebar-link @(currentArea == "admin" && currentController == "profile" && currentAction == "edit" ? "active" : "")"
                   asp-area="Admin" asp-controller="Profile" asp-action="Edit">
                    <i class="bi bi-person"></i>
                    ویرایش پروفایل
                </a>

                <a class="sidebar-link @(currentArea == "admin" && currentController == "profile" && currentAction == "changepassword" ? "active" : "")"
                   asp-area="Admin" asp-controller="Profile" asp-action="ChangePassword">
                    <i class="bi bi-key"></i>
                    تغییر رمز عبور
                </a>

                <a class="sidebar-link @(currentArea == "admin" && currentController == "profile" && currentAction == "loginlog" ? "active" : "")"
                   asp-area="Admin" asp-controller="Profile" asp-action="LoginLog">
                    <i class="bi bi-clock-history"></i>
                    لاگ ورود
                </a>

                <a class="sidebar-link text-danger"
                   asp-controller="Authentication" asp-action="Logout">
                    <i class="bi bi-box-arrow-left"></i>
                    خروج
                </a>
            </div>
        </div>

        <!-- DYNAMIC MENU -->

        <div class="sidebar-group-title px-2 text-muted mt-4 small">
            مدیریت سامانه
        </div>
        <ul class="list-unstyled px-2">

            <li>
                <a class="sidebar-link @(currentArea == "project" && currentController == "securityquestion" ? "active" : "")"
                   asp-area="Project" asp-controller="SecurityQuestion" asp-action="Index">
                    <i class="bi bi-shield-check"></i>
                    سوالات امنیتی
                </a>
            </li>

            <li>
                <a class="sidebar-link @(currentArea == "project" && currentController == "sendernumberspeciality" ? "active" : "")"
                   asp-area="Project" asp-controller="SenderNumberSpeciality" asp-action="Index">
                    <i class="bi bi-list-ul"></i>
                    حوزه‌ تخصصی سرشماره
                </a>
            </li>



            <li>
                <a class="sidebar-link @(currentArea == "project" && currentController == "sendernumbersubarea" ? "active" : "")"
                   asp-area="Project" asp-controller="SenderNumberSubArea" asp-action="Index">
                    <i class="bi bi-diagram-3"></i>
                    حوزه‌ فرعی سرشماره
                </a>
            </li>

            <li>
                <a class="sidebar-link @(currentArea == "project" && currentController == "systemmenu" ? "active" : "")"
                   asp-area="Project" asp-controller="SystemMenu" asp-action="Index">
                    <i class="bi bi-menu-button-wide"></i>
                    منوها
                </a>
            </li>

            <li>
                <a class="sidebar-link @(currentArea == "project" && currentController == "systemrole" ? "active" : "")"
                   asp-area="Project" asp-controller="SystemRole" asp-action="Index">
                    <i class="bi bi-people"></i>
                    نقش‌ها
                </a>
            </li>

            <li>
                <a class="sidebar-link @(currentArea == "project" && currentController == "systemuser" ? "active" : "")"
                   asp-area="Project" asp-controller="SystemUser" asp-action="Index">
                    <i class="bi bi-person-badge"></i>
                    کاربران
                </a>
            </li>
            <li>
                <a class="sidebar-link @(currentArea == "project" && currentController == "sendernumberorganizationlevels" ? "active" : "")"
                   asp-area="Project" asp-controller="sendernumberorganizationlevels" asp-action="Index">
                    <i class="bi bi-list-ul"></i>
                    رده های سازمانی سر شماره
                </a>
            </li>

            <li>
                <a class="sidebar-link @(currentArea == "project" && currentController == "Units" ? "active" : "")"
                   asp-area="Project" asp-controller="Units" asp-action="Index">
                    <i class="bi bi-list-ul"></i>
                    واحد های سازمانی
                </a>

            </li>
        </ul>

        <ul class="list-unstyled px-2 mt-3 accordion" id="mainMenu">

            @foreach (var menu in Menus.Where(m => m.ParentId == null && m.ShowInMenu).OrderBy(m => m.Order))
            {
                var childs = Menus
                .Where(m => m.ParentId == menu.Id && m.ShowInMenu)
                .OrderBy(m => m.Order)
                .ToList();

                bool hasChildren = childs.Any();

                bool hasActiveChild = childs.Any(child =>
                (child.Area ?? "").ToLower() == currentArea &&
                (child.Controller ?? "").ToLower() == currentController &&
                (child.Action ?? "").ToLower() == currentAction
                );

                bool isActiveParent =
                (menu.Area ?? "").ToLower() == currentArea &&
                (menu.Controller ?? "").ToLower() == currentController &&
                (string.IsNullOrEmpty(menu.Action) ||
                (menu.Action ?? "").ToLower() == currentAction ||
                hasActiveChild);

                string collapseId = $"menu_{menu.Id}";

                <li class="mb-1">

                    @if (hasChildren && !menu.HasLink)
                    {
                        <button class="sidebar-link accordion-button w-100 text-start @(hasActiveChild ? "" : "collapsed")"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#@collapseId"
                                aria-expanded="@(hasActiveChild.ToString().ToLower())"
                                aria-controls="@collapseId">

                            <i class="@menu.Icon"></i>
                            @menu.Title
                        </button>
                    }
                    else
                    {
                        <a class="sidebar-link @(isActiveParent ? "active" : "")"
                           href="@Url.Action(menu.Action, menu.Controller, new { area = menu.Area })">
                            <i class="@menu.Icon"></i>
                            @menu.Title
                        </a>
                    }

                    @if (hasChildren)
                    {
                        <div id="@collapseId"
                             class="accordion-collapse collapse @(hasActiveChild ? "show" : "")"
                             data-bs-parent="#mainMenu">

                            <div class="submenu accordion-body">

                                @foreach (var child in childs)
                                {
                                    bool isChildActive =
                                    (child.Area ?? "").ToLower() == currentArea &&
                                    (child.Controller ?? "").ToLower() == currentController &&
                                    (child.Action ?? "").ToLower() == currentAction;

                                    <a class="@(isChildActive ? "active" : "")"
                                       href="@Url.Action(child.Action, child.Controller, new { area = child.Area })">
                                        <i class="@child.Icon"></i>
                                        @child.Title
                                    </a>
                                }

                            </div>
                        </div>
                    }

                </li>
            }

            <div class="sidebar-group-title px-2 text-muted mt-4 small">
                سامانه
            </div>

            <li>
                <a class="sidebar-link @(currentArea == "admin" && currentController == "dashboard" && currentAction == "clearcache" ? "active" : "")"
                   asp-area="Admin" asp-controller="Dashboard" asp-action="ClearCache">
                    <i class="bi bi-arrow-repeat"></i>
                    پاک‌سازی کش
                </a>
            </li>

        </ul>
        <!-- DARK MODE -->
        <div class="p-3 border-top text-center">
            <button id="toggleDark" class="btn btn-sm btn-secondary w-100">
                <i class="bi bi-moon"></i>
                حالت شب / روز
            </button>
        </div>

    </aside>

    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- MAIN -->
    <main class="main-content">

        <nav class="navbar px-3 d-flex align-items-center">
            <button id="btnToggleSidebar" class="btn btn-outline-secondary d-md-none me-2">
                <i class="bi bi-list"></i>
            </button>

            <h6 class="fw-bold mb-0">@ViewData["Title"]</h6>

            <div class="ms-auto"></div>
        </nav>

        <div class="p-4">
            @RenderBody()
        </div>

        <footer class="text-center py-3 text-muted small">
            © @DateTime.Now.Year – @Config.SiteNameFa
        </footer>

    </main>


    <!-- SCRIPTS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- ADD THESE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <script>
        $.extend(true, $.fn.dataTable.defaults, {
            renderer: 'bootstrap'
        });
    </script>

    <!-- TomSelect -->
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>



    <!-- Sidebar + Dark Mode -->
    <script>
        (function () {

            const sidebar = document.getElementById("sidebarMenu");
            const backdrop = document.getElementById("sidebarBackdrop");
            const toggleBtn = document.getElementById("btnToggleSidebar");

            toggleBtn?.addEventListener("click", () => {
                const isShown = sidebar.classList.contains("show");
                if (!isShown) {
                    sidebar.classList.add("show");
                    backdrop.classList.add("show");
                }
                else {
                    sidebar.classList.remove("show");
                    backdrop.classList.remove("show");
                }
            });

            backdrop.addEventListener("click", () => {
                sidebar.classList.remove("show");
                backdrop.classList.remove("show");
            });

            window.addEventListener("resize", () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove("show");
                    backdrop.classList.remove("show");
                }
            });

            const body = document.body;
            const toggleDark = document.getElementById("toggleDark");

            if (localStorage.getItem("darkmode") === "on")
                body.classList.add("dark");

            toggleDark.addEventListener("click", () => {
                body.classList.toggle("dark");
                localStorage.setItem(
                    "darkmode",
                    body.classList.contains("dark") ? "on" : "off"
                );
            });

        })();
    </script>

    <!-- TomSelect init -->
    <script>
        function initTomSelect() {
            document.querySelectorAll("select").forEach(function (el) {

                // ❶: سلکت‌های دیتاتیبل (تعداد ردیف‌ها) را دست نزن
                if (el.closest('.dataTables_length')) {
                    return;
                }

                // ❷: اگر قبلاً تبدیل شده، دوباره تبدیلش نکن
                if (el.tomselect || el.classList.contains('ts-hidden-accessible')) {
                    return;
                }

                new TomSelect(el, {
                    maxOptions: 500,
                    sortField: { field: "text", direction: "asc" },
                    render: {
                        option: data => `<div class="py-1 px-2">${data.text}</div>`,
                        item: data => `<div class="py-1">${data.text}</div>`
                    }
                });
            });
        }


        document.addEventListener("DOMContentLoaded", initTomSelect);
        document.addEventListener("shown.bs.modal", initTomSelect);
    </script>

    @RenderSection("Scripts", required: false)
    <!-- Global Modal -->
    <div class="modal fade" id="base-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" id="modal-form">
                <!-- Ajax content loads here -->
            </div>
        </div>
    </div>

</body>
</html>
